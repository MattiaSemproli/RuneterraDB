<!DOCTYPE HTML>
<!--
	Solid State by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>

	<head>
		<title>RuneterraDB | Guess the champion</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="../assets/css/main.css" />
		<link rel="stylesheet" href="../assets/css/centerBox.css" />
		<noscript>
			<link rel="stylesheet" href="../assets/css/noscript.css" />
		</noscript>
	</head>

	<body>

		<!-- Header -->
		<header id="header" class="alt">
			<nav>
				<a href="#menu">Menu</a>
			</nav>
		</header>

		<!-- Menu -->
		<nav id="menu">
			<div class="inner">
				<h2>Menu</h2>
				<ul class="links">
					<li><a href="index.html">Home</a></li>
					<li><a href="wiki.html">Wiki</a></li>
					<li><a href="../php/logout.php">Log Out</a></li>
				</ul>
				<a href="#" class="close">Close</a>
			</div>
		</nav>

		<!-- Center -->
		<div id="guess-the-champion">
			<form>
				<input type="text" id="champion-name" name="champion-name" placeholder="Enter champion name ...." list="champion-options" autocomplete="off">
				<datalist id="champion-options"></datalist>
				<button type="submit" id="submit-Button" disabled>Submit</button>
			</form>
			<ul id="champion-guessed" style="list-style-type: none; background-color: black; border-radius: 10px;"></ul>
		</div>

		<script>
			window.addEventListener('load', function() {
				var xhr = new XMLHttpRequest();
				xhr.open('GET', '../php/getChampionWiki.php', true);
				xhr.onload = function() {
					if (xhr.status === 200) {
						var chs = JSON.parse(xhr.responseText);
						if (!document.cookie.includes('randomChamp')) {
							extractRandomChampion(chs);
						}
						generateChampionNamesCookie(chs);
						loadChsOptions();
					} else {
						console.log('Error in the request: ' + xhr.status);
					}
				};
				xhr.send();
			});
			
			function extractRandomChampion(chs) {
				var rndId = Math.floor(Math.random() * chs.length);
				var tomorrow = new Date();
				tomorrow.setDate(new Date().getDate() + 1);
				tomorrow.setHours(0, 0, 0, 0);
				document.cookie = "randomChamp=" + chs[rndId] + "; expires=" + tomorrow.toUTCString() + "; path=/html/gtc.html";
			}
			
			function generateChampionNamesCookie(chs) {
				var nameList = Array();
				chs.forEach(element => {
					nameList.push(element[0]);
				});
				document.cookie = "nameChs=" + JSON.stringify(nameList) + "; path=/html/gtc.html";
			} 

			function loadChsOptions() {
				var cookieValue = document.cookie
										  .split('; ')
										  .find(cookie => cookie.startsWith('nameChs='))
										  ?.split('=')[1];
				var options = Array();
				if(cookieValue) {
					JSON.parse(cookieValue).forEach(element => {	
						options.push(element);
					});
				}

				while (champsList.firstChild) {
					champsList.removeChild(champsList.firstChild);
				}

				options.forEach(option => {
					const newOption = document.createElement('option');
					newOption.value = option;
					champsList.appendChild(newOption);
				});
			}

			const form = document.querySelector('form');
			const champsList = document.getElementById('champion-options');
			const champsTyped = document.getElementById('champion-guessed');
			const input = document.getElementById('champion-name');
			const submitBtn = document.getElementById('submit-Button');

			form.addEventListener('submit', event => {
				event.preventDefault();

				var cookieValue = document.cookie
										  .split('; ')
										  .find(cookie => cookie.startsWith('nameChs='))
										  ?.split('=')[1];
				var chsNames = Array();
				if(cookieValue) {
					JSON.parse(cookieValue).forEach(element => {	
						chsNames.push(element);
					});
					chsNames.splice(chsNames.indexOf(input.value), 1);
					document.cookie = "nameChs=" + JSON.stringify(chsNames) + "; path=/html/gtc.html";
				}
				
				var toGuess = document.cookie
								 .split('; ')
								 .find(cookie => cookie.startsWith('randomChamp='))
								 ?.split('=')[1]
								 .split(',');

				var guess = input.value.toLowerCase().split(' ');
				for (var i = 0; i < guess.length; i++) {
					guess[i] = guess[i].charAt(0).toUpperCase() + guess[i].slice(1);
				}
				var guess = guess.join(' ');
				
				var xhr = new XMLHttpRequest();
				xhr.open('GET', '../php/requestGuess.php?n=' + encodeURIComponent(guess), true);
				xhr.onload = function() {
					if (xhr.status === 200) {
						var x = JSON.parse(xhr.responseText);
						const newChampItem = document.createElement('li');
						for (var i = 0; i < x.length; i++) {
							if (x[i] === toGuess[i]) {
								newChampItem.innerHTML+=('<span style="color: green">' + x[i] + '</span>, ');
							} else {
								newChampItem.innerHTML+=('<span style="color: red">' + x[i] + '</span>, ');
							}
						}
						champsTyped.prepend(document.createElement('br'));
						champsTyped.prepend(newChampItem);
						champsTyped.prepend(document.createElement('br'));
						form.reset();
						loadChsOptions();
						submitBtn.disabled = true;
					} else {
						console.log('Error in the request: ' + xhr.status);
					}
				};
				xhr.send();
			});

			input.addEventListener('input', () => {
				var cookieValue = document.cookie
										  .split('; ')
										  .find(cookie => cookie.startsWith('nameChs='))
										  ?.split('=')[1];
				var options = Array();
				if(cookieValue) {
					JSON.parse(cookieValue).forEach(element => {	
						options.push(element.toLowerCase());
					});
				}
				if (options.includes(input.value.toLowerCase())) {
					submitBtn.disabled = false;
				} else {
					submitBtn.disabled = true;
				}
			});
		</script>

		<!-- Footer -->
		<footer id="footer">
			<div class="inner">
				<ul class="copyright">
					<li>&copy; All rights reserved to Mattia Semproli & Martino Pagliarani</li>
				</ul>
			</div>
			</section>

			<!-- Scripts -->
			<script src="../assets/js/jquery.min.js"></script>
			<script src="../assets/js/jquery.scrollex.min.js"></script>
			<script src="../assets/js/browser.min.js"></script>
			<script src="../assets/js/breakpoints.min.js"></script>
			<script src="../assets/js/util.js"></script>
			<script src="../assets/js/main.js"></script>

	</body>

</html>